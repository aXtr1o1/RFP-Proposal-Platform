name: Deploy to Azure Web Apps

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "22.x"
  AZURE_WEBAPP_BACKEND: "rfp-proposal-backend"
  AZURE_WEBAPP_FRONTEND: "rfp-proposal-frontend"

jobs:
  backend:
    name: Deploy FastAPI backend
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate backend dependencies
        working-directory: apps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Assemble backend package
        run: |
          mkdir -p backend_package
          rsync -a apps/ backend_package/apps/
          cp apps/requirements.txt backend_package/requirements.txt
          cp deploy/backend_startup.sh backend_package/startup.sh
          chmod +x backend_package/startup.sh
          cd backend_package
          zip -r ../backend.zip .

      - name: Deploy backend to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_BACKEND }}
          publish-profile: ${{ secrets.AZURE_BACKEND_PUBLISH_PROFILE }}
          package: backend.zip

  frontend:
    name: Deploy Next.js frontend
    runs-on: ubuntu-latest
    needs: backend
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install dependencies
        working-directory: apps/frontend
        run: npm ci --include=optional

      - name: Rebuild native bindings
        working-directory: apps/frontend
        run: npm rebuild @tailwindcss/oxide lightningcss --force || true

      - name: Build frontend
        working-directory: apps/frontend
        run: npm run build

      - name: Prepare frontend artifact
        run: |
          mkdir -p frontend_package
          rsync -a apps/frontend/ frontend_package/ --exclude node_modules --exclude .next
          rsync -a apps/frontend/.next/ frontend_package/.next/
          cd frontend_package
          zip -r ../frontend.zip .

      - name: Deploy frontend to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_FRONTEND }}
          publish-profile: ${{ secrets.AZURE_FRONTEND_PUBLISH_PROFILE }}
          package: frontend.zip
