import re
import json
import ast
import json
import re
from typing import Any, Dict, List

input_text = """
{'title': 'مقترح شامل للرد على طلب العروض (RFP)', 'sections': [{'heading': 'مقدمة', 'content': "تتضمن هذه الوثيقة تعريفات أساسية للمصطلحات المستخدمة في هذا المقترح، مثل 'الجهة الحكومية'، 'مقدم العرض'، 'المنافسة'، و'الخدمات'. سيتم استخدام هذه التعريفات لضمان فهم مشترك بين جميع الأطراف المعنية.", 'points': ['تعريف عن المنافسة', 'المواعيد المتعلقة بالمنافسة', 'أهلية مقدمي العروض'], 'table': {'headers': ['المصطلح', 'التعريف'], 'rows': [['الجهة الحكومية', 'الجهة المسؤولة عن طلب العروض'], ['مقدم العرض', 'الشخص أو الشركة التي تقدم العرض'], ['المنافسة', 'العملية التي يتم من خلالها تقديم العروض']]}}, {'heading': 'الأحكام العامة', 'content': 'تلتزم [اسم الشركة] بتوفير كافة المعلومات اللازمة للجهة الحكومية، مع ضمان عدم التمييز بين المتنافسين، مما يعزز من مبدأ الشفافية.', 'points': ['المساواة والشفافية', 'تعارض المصالح', 'السلوكيات والأخلاقيات'], 'table': {'headers': ['المبدأ', 'التفاصيل'], 'rows': [['المساواة', 'ضمان عدم التمييز بين المتنافسين'], ['شفافية', 'توفير كافة المعلومات اللازمة'], ['تعارض المصالح', 'الإفصاح عن أي حالات تعارض محتملة']]}}, {'heading': 'إعداد العروض', 'content': 'ستكون مدة صلاحية العرض 90 يومًا من تاريخ فتح العروض، مما يضمن استمرارية الالتزام.', 'points': ['تأكيد المشاركة بالمنافسة', 'لغة العرض', 'وثائئق العرض الفني'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['اللغة', 'سيتم تقديم العرض باللغة العربية'], ['مدة الصلاحية', '90 يومًا من تاريخ فتح العروض'], ['وثائق العرض الفني', 'وصف تفصيلي للمشروع']]}}, {'heading': 'تقديم العروض', 'content': 'سيتم تقديم العروض عببر منصة اعتماد، مع تقديم الضمان البنكي الابتدائي بشكل منفصل.', 'points': ['آلية تقديم العروض', 'فتح العروض'], 'table': {'headers': ['الإجراء', 'التفاصيل'], 'rows': [['تقديم العروض', 'عبر منصة اعتماد'], ['فتح العروض', 'بحضور ممثلين عن الجهة الحكومية']]}}, {'heading': 'تقييم العروض', 'content': 'سيتم تقييم العروض بناءً على معايير فنية ومالية، مع تحديد وزن كل معيار وفقًا لما هو موضح في الوثيقة.', 'points': ['معا ايير تقييم العروض', 'تصحيح العروض'], 'table': {'headers': ['المعيار', 'التفاصيل'], 'rows': [['فني', 'تقييم الخبرة والكفاءة الفنية'], ['مالي', 'تحليل الأسعار والتكاليف']]}}, {'heading': 'متطلبات التعاقد', 'content': 'ستقوم الجهة الحكومية بإخطار الفائزين بالترسية عبر البوابة الإلكترونية، مع توضيح نطاق العمل والقيمة.', 'points': ['إخطار الترسية', 'الضمان النهائي'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['إخطار الترسية', 'عبر البوابة الإلكترونية'], ['الضمان النهائي', '5% من قيمة العقد']]}}, {'heading': 'نطاق العمل المفصل', 'content': 'سيتم تنفيذ المشروع على مراحل، تشمل التخطيط، تحليل الوظائف، صياغة الأوصاف الوظيفية، وتقديم البرامج التأهيلية.', 'points': ['نطاق عمل المشروع', 'برنامج تقديم الخدمات'], 'table': {'headers': ['المرحلة', 'التفاصيل'], 'rows': [['التخطيط', 'تحديد المتطلبات والأهداف'], ['تحليل الوظائف', 'تقييم الاحتياجات الوظيفية']]}}, {'heading': 'المواصفات', 'content': 'سيتم تشكيل فريق عمل مؤهل يتضمن خبراء في مجالات إدارة المشاريع، بناء القدرات، والتدريب.', 'points': ['فريق العمل', 'كيفية تنفيذ الخدمات الاستشارية'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['فريق العمل', 'خبراء في إدارة المشاريع والتدريب'], ['تنفيذ الخدمات', 'وفق منهجية واضحة ومعتمدة']]}}, {'heading': 'الشروط الخاصة', 'content': 'تتعهد [اسم الشركة] بتقديم المخرجات والوثائق الداعمة وفقًا للجدول الزمني المتفق عليه.', 'points': ['الالتزام بالمخرجات', 'التقارير الدورية'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['الالتزام بالمخرجات', 'تقديم الوثائق وفق الجدول الزمني'], ['التقارير', 'ربع سنوية قبل نهاية كل ربع']]}}, {'heading': 'خطة إدارة المشروع', 'content': 'ستقوم [اسم الشركة] بإجراء تحليل شامل للمخاطر المحتملة، مع وضع استراتيجيات للتخفيف منها.', 'points': ['تحليل المخاطر', 'مقاييس الأداء'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['تحليل المخاطر', 'تحديد المخاطر ووضع استراتيجيات للتعامل معها'], ['مقاييس الأداء', 'تحديد مؤشرات الأداء الرئيسية']]}}]}
لإلكترونية، مع توضيح نطاق العمل والقيمة.', 'points': ['إخطار الترسية', 'الضمان النهائي'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['إخطار الترسية', 'عبر البوابة الإلكترونية'], ['الضمان النهائي', '5% من قيمة العقد']]}}, {'heading': 'نطاق العمل المفصل', 'content': 'سيتم تنفيذ المشروع على مراحل، تشمل التخطيط، تحليل الوظائف، صياغة الأوصاف الوظيفية، وتقديم البرامج التأهيلية.', 'points': ['نطاق عمل المشروع', 'برنامج تقديم الخدمات'], 'table': {'headers': ['المرحلة', 'التفاصيل'], 'rows': [['التخطيط', 'تحديد المتطلبات والأهداف'], ['تحليل الوظائف', 'تقييم الاحتياجات الوظيفية']]}}, {'heading': 'المواصفات', 'content': 'سيتم تشكيل فريق عمل مؤهل يتضمن خبراء في مجالات إدارة المشاريع، بناء القدرات، والتدريب.', 'points': ['فريق العمل', 'كيفية تنفيذ الخدمات الاستشارية'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['فريق العمل', 'خبراء في إدارة المشاريع والتدريب'], ['تنفيذ الخدمات', 'وفق منهجية واضحة ومعتمدة']]}}, {'heading': 'الشروط الخاصة', 'content': 'تتعهد [اسم الشركة] بتقديم المخرجات والوثائق الداعمة وفقًا للجدول الزمني المتفق عليه.', 'points': ['الالتزام بالمخرجات', 'التقارير الدورية'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['الالتزام بالمخرجات', 'تقديم الوثائق وفق الجدول الزمني'], ['التقارير', 'ربع سنوية قبل نهاية كل ربع']]}}, {'heading': 'خطة إدارة المشروع', 'content': 'ستقوم [اسم الشركة] بإجراء تحليل شامل للمخاطر المحتملة، مع وضع استراتيجيات للتخفيف منها.', 'points': ['تحليل المخاطر', 'مقاييس الأداء'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['تحليل المخاطر', 'تحديد المخاطر ووضع استراتيجيات للتعامل معها'], ['مقاييس الأداء', 'تحديد مؤشرات الأداء الرئيسية']]}}]}
ws': [['إخطار الترسية', 'عبر البوابة الإلكترونية'], ['الضمان النهائي', '5% من قيمة العقد']]}}, {'heading': 'نطاق العمل المفصل', 'content': 'سيتم تنفيذ المشروع على مراحل، تشمل التخطيط، تحليل الوظائف، صياغة الأوصاف الوظيفية، وتقديم البرامج التأهيلية.', 'points': ['نطاق عمل المشروع', 'برنامج تقديم الخدمات'], 'table': {'headers': ['المرحلة', 'التفاصيل'], 'rows': [['التخطيط', 'تحديد المتطلبات والأهداف'], ['تحليل الوظائف', 'تقييم الاحتياجات الوظيفية']]}}, {'heading': 'المواصفات', 'content': 'سيتم تشكيل فريق عمل مؤهل يتضمن خبراء في مجالات إدارة المشاريع، بناء القدرات، والتدريب.', 'points': ['فريق العمل', 'كيفية تنفيذ الخدمات الاستشارية'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['فريق العمل', 'خبراء في إدارة المشاريع والتدريب'], ['تنفيذ الخدمات', 'وفق منهجية واضحة ومعتمدة']]}}, {'heading': 'الشروط الخاصة', 'content': 'تتعهد [اسم الشركة] بتقديم المخرجات والوثائق الداعمة وفقًا للجدول الزمني المتفق عليه.', 'points': ['الالتزام بالمخرجات', 'التقارير الدورية'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['الالتزام بالمخرجات', 'تقديم الوثائق وفق الجدول الزمني'], ['التقارير', 'ربع سنوية قبل نهاية كل ربع']]}}, {'heading': 'خطة إدارة المشروع', 'content': 'ستقوم [اسم الشركة] بإجراء تحليل شامل للمخاطر المحتملة، مع وضع استراتيجيات للتخفيف منها.', 'points': ['تحليل المخاطر', 'مقاييس الأداء'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['تحليل المخاطر', 'تحديد المخاطر ووضع استراتيجيات للتعامل معها'], ['مقاييس الأداء', 'تحديد مؤشرات الأداء الرئيسية']]}}]}
: 'سيتم تنفيذ المشروع على مراحل، تشمل التخطيط، تحليل الوظائف، صياغة الأوصاف الوظيفية، وتقديم البرامج التأهيلية.', 'points': ['نطاق عمل المشروع', 'برنامج تقديم الخدمات'], 'table': {'headers': ['المرحلة', 'التفاصيل'], 'rows': [['التخطيط', 'تحديد المتطلبات والأهداف'], ['تحليل الوظائف', 'تقييم الاحتياجات الوظيفية']]}}, {'heading': 'المواصفات', 'content': 'سيتم تشكيل فريق عمل مؤهل يتضمن خبراء في مجالات إدارة المشاريع، بناء القدرات، والتدريب.', 'points': ['فريق العمل', 'كيفية تنفيذ الخدمات الاستشارية'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['فريق العمل', 'خبراء في إدارة المشاريع والتدريب'], ['تنفيذ الخدمات', 'وفق منهجية واضحة ومعتمدة']]}}, {'heading': 'الشروط الخاصة', 'content': 'تتعهد [اسم الشركة] بتقديم المخرجات والوثائق الداعمة وفقًا للجدول الزمني المتفق عليه.', 'points': ['الالتزام بالمخرجات', 'التقارير الدورية'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['الالتزام بالمخرجات', 'تقديم الوثائق وفق الجدول الزمني'], ['التقارير', 'ربع سنوية قبل نهاية كل ربع']]}}, {'heading': 'خطة إدارة المشروع', 'content': 'ستقوم [اسم الشركة] بإجراء تحليل شامل للمخاطر المحتملة، مع وضع استراتيجيات للتخفيف منها.', 'points': ['تحليل المخاطر', 'مقاييس الأداء'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['تحليل المخاطر', 'تحديد المخاطر ووضع استراتيجيات للتعامل معها'], ['مقاييس الأداء', 'تحديد مؤشرات الأداء الرئيسية']]}}]}
الوظائف', 'تقييم الاحتياجات الوظيفية']]}}, {'heading': 'المواصفات', 'content': 'سيتم تشكيل فريق عمل مؤهل يتضمن خبراء في مجالات إدارة المشاريع، بناء القدرات، والتدريب.', 'points': ['فريق العمل', 'كيفية تنفيذ الخدمات الاستشارية'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['فريق العمل', 'خبراء في إدارة المشاريع والتدريب'], ['تنفيذ الخدمات', 'وفق منهجية واضحة ومعتمدة']]}}, {'heading': 'الشروط الخاصة', 'content': 'تتعهد [اسم الشركة] بتقديم المخرجات والوثائق الداعمة وفقًا للجدول الزمني المتفق عليه.', 'points': ['الالتزام بالمخرجات', 'التقارير الدورية'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['الالتزام بالمخرجات', 'تقديم الوثائق وفق الجدول الزمني'], ['التقارير', 'ربع سنوية قبل نهاية كل ربع']]}}, {'heading': 'خطة إدارة المشروع', 'content': 'ستقوم [اسم الشركة] بإجراء تحليل شامل للمخاطر المحتملة، مع وضع استراتيجيات للتخفيف منها.', 'points': ['تحليل المخاطر', 'مقاييس الأداء'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['تحليل المخاطر', 'تحديد المخاطر ووضع استراتيجيات للتعامل معها'], ['مقاييس الأداء', 'تحديد مؤشرات الأداء الرئيسية']]}}]}
rows': [['فريق العمل', 'خبراء في إدارة المشاريع والتدريب'], ['تنفيذ الخدمات', 'وفق منهجية واضحة ومعتمدة']]}}, {'heading': 'الشروط الخاصة', 'content': 'تتعهد [اسم الشركة] بتقديم المخرجات والوثائق الداعمة وفقًا للجدول الزمني المتفق عليه.', 'points': ['الالتزام بالمخرجات', 'التقارير الدورية'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['الالتزام بالمخرجات', 'تقديم الوثائق وفق الجدول الزمني'], ['التقارير', 'ربع سنوية قبل نهاية كل ربع']]}}, {'heading': 'خطة إدارة المشروع', 'content': 'ستقوم [اسم الشركة] بإجراء تحليل شامل للمخاطر المحتملة، مع وضع استراتيجيات للتخفيف منها.', 'points': ['تحليل المخاطر', 'مقاييس الأداء'], 'table': {'headers': ['البند', 'التفاصيل'], 'rows': [['تحليل المخاطر', 'تحديد المخاطر ووضع استراتيجيات للتعامل معها'], ['مقاييس الأداء', 'تحديد مؤشرات الأداء الرئيسية']]}}]}
"""
def first_balanced_brace_block(s: str) -> str:
    """
    Return the first balanced {...} block from s (handles extra garbage/duplicates after it).
    """
    start = s.find('{')
    if start == -1:
        raise ValueError("No opening '{' found in input.")
    depth = 0
    for i in range(start, len(s)):
        ch = s[i]
        if ch == '{':
            depth += 1
        elif ch == '}':
            depth -= 1
            if depth == 0:
                return s[start:i+1]
    raise ValueError("No balanced closing '}' found.")

def normalize_quotes(s: str) -> str:
    """
    Normalize curly quotes and weird punctuation that often appear in copy-pastes.
    We DO NOT convert all single quotes to double quotes (that caused your error).
    """
    s = s.replace('\u2018', "'").replace('\u2019', "'")
    s = s.replace('\u201c', '"').replace('\u201d', '"')
    s = s.replace('،', ',')
    return s



def safe_literal_eval(s: str) -> Any:
    """
    Try to parse a Python-literal-style dict string robustly.
    Falls back to a targeted fix if trailing commas or duplicated commas appear.
    """
    try:
        return ast.literal_eval(s)
    except Exception as e:
        # Common issue: stray ",," or ", ]" / ", }" from corrupted paste
        fixed = re.sub(r',\s*([}\]])', r'\1', s)   
        fixed = re.sub(r',\s*,', r', ', fixed)     
        try:
            return ast.literal_eval(fixed)
        except Exception as e2:
            raise ValueError(f"Could not parse input as Python literal.\nOriginal error: {e}\nAfter fixes: {e2}")




def dedupe_sections_by_heading(obj: Dict[str, Any]) -> Dict[str, Any]:
    """
    Remove duplicate sections by 'heading' while preserving the first occurrence.
    """
    sections = obj.get("sections", [])
    seen = set()
    deduped: List[Dict[str, Any]] = []
    for sec in sections:
        heading = sec.get("heading")
        if heading and heading not in seen:
            seen.add(heading)
            deduped.append(sec)
    obj["sections"] = deduped
    return obj

def proposal_cleaner(input_text: str) -> str:
    normalized = normalize_quotes(input_text)
    block = first_balanced_brace_block(normalized)
    parsed = safe_literal_eval(block)
    if isinstance(parsed, dict):
        parsed = dedupe_sections_by_heading(parsed)
    cleaned_text = json.dumps(parsed, ensure_ascii=False, indent=2)
    print(cleaned_text)

    return cleaned_text

